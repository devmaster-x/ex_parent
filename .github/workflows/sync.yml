name: Sync Child Repo Changes

on:
  workflow_dispatch: {}  # Manual trigger
  # Triggered by child repo when main branch is updated

jobs:
  sync-child-repo:
    runs-on: ubuntu-latest
    concurrency:
      group: sync-child-repo
      cancel-in-progress: false
    
    env:
      PARENT_REPO: ${{ github.repository }}
      PARENT_BRANCH: main  # Base branch for new sync branch
      CHILD_REPO: ${{ vars.CHILD_REPO || 'devmaster-x/ex_child' }}  # Child repo reference
      CHILD_BRANCH: main  # Child repo main branch
      CHILD_MODULE_PATH: ./app  # Root of child repo
      PARENT_MODULE_PATH: ./app  # Target path in parent repo

    steps:
      - name: Checkout parent repo (main branch)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.PARENT_BRANCH }}
          fetch-depth: 0
          token: ${{ secrets.CHILD_REPO_TOKEN }}  # Use PAT for authentication

      - name: Configure Git Authentication
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # Configure git to use the PAT for authentication
          git remote set-url origin https://x-access-token:${{ secrets.CHILD_REPO_TOKEN }}@github.com/${{ github.repository }}.git
          echo "Updated git remote URL with PAT authentication"

      - name: Update main branch
        run: |
          # Ensure we have the latest changes from main branch
          git fetch origin
          git reset --hard origin/${{ env.PARENT_BRANCH }}
          echo "Updated to latest ${{ env.PARENT_BRANCH }} branch"

      - name: Set timestamp
        run: |
          TIMESTAMP=$(date '+%Y-%m-%d-%H-%M-%S')
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
          echo "Set timestamp: $TIMESTAMP"

      - name: Create sync branch
        run: |
          # Create a more unique branch name with timestamp and run ID
          BRANCH_NAME="sync-child-repo-${{ github.run_id }}-${{ env.TIMESTAMP }}"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          
          # Check if branch already exists locally and delete it
          if git branch --list "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Local branch $BRANCH_NAME already exists, deleting it..."
            git branch -D "$BRANCH_NAME"
          fi
          
          # Create the new branch
          git checkout -b "$BRANCH_NAME"
          echo "Created branch: $BRANCH_NAME"

      - name: Checkout child repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.CHILD_REPO }}
          ref: ${{ env.CHILD_BRANCH }}
          path: child-repo
          token: ${{ secrets.CHILD_REPO_TOKEN }}  # PAT with access to child repo
          fetch-depth: 0
          submodules: false  # Explicitly disable submodules

      - name: Sync child repo -> parent repo
        run: |
          echo "=== STARTING SYNC PROCESS ==="
          echo "Current working directory: $(pwd)"
          echo "Child repo path: child-repo"
          echo "Target path: ${{ env.PARENT_MODULE_PATH }}"
          
          echo ""
          echo "=== CHILD REPO CONTENTS ==="
          echo "Root contents:"
          ls -la child-repo/
          echo ""
          echo "App directory contents:"
          ls -la child-repo/app/
          
          echo ""
          echo "=== TARGET DIRECTORY STATUS ==="
          echo "Target directory before sync:"
          ls -la "${{ env.PARENT_MODULE_PATH }}/" || echo "Target directory doesn't exist yet"
          
          echo ""
          echo "=== PERFORMING SYNC ==="
          
          # Create target directory if it doesn't exist
          mkdir -p "${{ env.PARENT_MODULE_PATH }}"
          
          # Remove all existing content in target directory
          echo "Removing existing content..."
          rm -rf "${{ env.PARENT_MODULE_PATH }}"/*
          
          # Copy ALL files from child repo app directory to target
          echo "Copying files from child-repo/app to ${{ env.PARENT_MODULE_PATH }}..."
          
          # Use rsync if available, otherwise use cp
          if command -v rsync &> /dev/null; then
            echo "Using rsync for copy..."
            rsync -av child-repo/app/ "${{ env.PARENT_MODULE_PATH }}/"
          else
            echo "Using cp for copy..."
            cp -rv child-repo/app/* "${{ env.PARENT_MODULE_PATH }/"
          fi
          
          echo ""
          echo "=== VERIFICATION ==="
          echo "Target directory contents after sync:"
          ls -la "${{ env.PARENT_MODULE_PATH }}/"
          
          echo ""
          echo "=== FILE COUNT COMPARISON ==="
          echo "Files in child repo app: $(find child-repo/app -type f | wc -l)"
          echo "Files in target directory: $(find "${{ env.PARENT_MODULE_PATH }}" -type f | wc -l)"
          
          echo ""
          echo "=== SYNC COMPLETE ==="

      - name: Clean up unwanted files
        run: |
          echo "=== CLEANING UP UNWANTED FILES ==="
          
          # Remove .git directory if it exists
          if [ -d "${{ env.PARENT_MODULE_PATH }}/.git" ]; then
            echo "Removing .git directory..."
            rm -rf "${{ env.PARENT_MODULE_PATH }}/.git"
          fi
          
          # Remove any other unnecessary files
          for file in .github .gitignore .gitattributes; do
            if [ -e "${{ env.PARENT_MODULE_PATH }}/$file" ]; then
              echo "Removing $file..."
              rm -rf "${{ env.PARENT_MODULE_PATH }}/$file"
            fi
          done
          
          echo "Cleanup complete!"

      - name: Verify sync results
        run: |
          echo "=== VERIFYING SYNC RESULTS ==="
          echo "Expected files: app.js, homepage.js, readme.md, style.css"
          echo ""
          
          # Check each expected file
          expected_files=("app.js" "homepage.js" "readme.md" "style.css")
          missing_files=()
          
          for file in "${expected_files[@]}"; do
            if [ -f "${{ env.PARENT_MODULE_PATH }}/$file" ]; then
              echo "âœ… $file found"
              echo "   Size: $(stat -c%s "${{ env.PARENT_MODULE_PATH }}/$file" 2>/dev/null || stat -f%z "${{ env.PARENT_MODULE_PATH }}/$file" 2>/dev/null || echo "unknown") bytes"
            else
              echo "âŒ $file missing"
              missing_files+=("$file")
            fi
          done
          
          echo ""
          echo "=== FINAL VERIFICATION ==="
          if [ ${#missing_files[@]} -eq 0 ]; then
            echo "ðŸŽ‰ All expected files are present!"
          else
            echo "âš ï¸  Missing files: ${missing_files[*]}"
            echo "Current target directory contents:"
            ls -la "${{ env.PARENT_MODULE_PATH }}/"
            exit 1
          fi

      - name: Debug git status
        run: |
          echo "=== GIT STATUS DEBUG ==="
          echo "Current git status:"
          git status
          echo ""
          echo "Staged files:"
          git diff --cached --name-only || echo "No staged files"
          echo ""
          echo "Modified files:"
          git diff --name-only || echo "No modified files"
          echo ""
          echo "Untracked files:"
          git ls-files --others --exclude-standard || echo "No untracked files"

      - name: Check for changes
        id: check-changes
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected, will create PR"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          fi

      - name: Commit changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git add "${{ env.PARENT_MODULE_PATH }}"
          git commit -m "Sync child repo from ${{ env.CHILD_REPO }} @ ${{ github.sha }}

          - Source: ${{ env.CHILD_REPO }}@${{ env.CHILD_BRANCH }}
          - Target: ${{ env.PARENT_MODULE_PATH }}
          - Timestamp: ${{ env.TIMESTAMP }}
          - Triggered by: ${{ github.event_name }}"

      - name: Clean up existing remote branch
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          # Check if remote branch exists and delete it if it does
          if git ls-remote --heads origin "${{ env.BRANCH_NAME }}" | grep -q "${{ env.BRANCH_NAME }}"; then
            echo "Remote branch ${{ env.BRANCH_NAME }} already exists, deleting it first..."
            git push origin --delete "${{ env.BRANCH_NAME }}" || true
            echo "Remote branch deleted successfully"
          else
            echo "No existing remote branch found"
          fi

      - name: Push sync branch
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          # Push the new branch
          git push origin "${{ env.BRANCH_NAME }}"
          echo "Pushed branch: ${{ env.BRANCH_NAME }}"

      - name: Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.CHILD_REPO_TOKEN }}
          commit-message: "Sync child repo from ${{ env.CHILD_REPO }} @ ${{ github.sha }}"
          branch: "${{ env.BRANCH_NAME }}"
          base: ${{ env.PARENT_BRANCH }}
          title: "Sync child repo from ${{ env.CHILD_REPO }} - ${{ env.TIMESTAMP }}"
          body: |
            ## Automated Sync of Child Repository
            
            This PR syncs the latest changes from the **child repository** to the **parent repository**.
            
            ### Details
            - **Source**: `${{ env.CHILD_REPO }}@${{ env.CHILD_BRANCH }}`
            - **Target**: `${{ env.PARENT_MODULE_PATH }}`
            - **Sync Time**: `${{ env.TIMESTAMP }}`
            - **Trigger**: `${{ github.event_name }}`
            
            ### What Changed
            - Updated `${{ env.PARENT_MODULE_PATH }}/` directory with latest child repo content
            - All files from child repo have been synchronized
            
            ### Review Notes
            - This is an automated sync - please review the changes
            - The sync preserves the structure and content from the source repository
            - Any conflicts should be resolved manually if they occur
            
            ---
            *This PR was automatically generated by GitHub Actions*
          labels: |
            automated
            sync
            child-repo
          assignees: |
            ${{ github.repository_owner }}
          # reviewers: |
          #   ${{ github.repository_owner }}

      - name: Cleanup on no changes
        if: steps.check-changes.outputs.has_changes == 'false'
        run: |
          echo "No changes to sync. Skipping PR creation."
          # Delete the branch if no changes
          git push origin --delete "${{ env.BRANCH_NAME }}" || true
